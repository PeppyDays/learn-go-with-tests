# Context

## Go Concurrency Patterns: Context

Summarised from [Go Concurrency Patterns: Context](https://go.dev/blog/context).

```go
// A Context carries a deadline, cancellation signal, and request-scoped values
// across API boundaries. Its methods are safe for simultaneous use by multiple
// goroutines.
type Context interface {
    // Done returns a channel that is closed when this Context is canceled
    // or times out.
    Done() <-chan struct{}

    // Err indicates why this context was canceled, after the Done channel
    // is closed.
    Err() error

    // Deadline returns the time when this Context will be canceled, if any.
    Deadline() (deadline time.Time, ok bool)

    // Value returns the value associated with key or nil if none.
    Value(key interface{}) interface{}
}
```

- The purpose of context package is to pass request-scoped values, cancellation signals, and deadlines across API boundaries to all the goroutines
- Request into a service generates context, and receivers related to the request accepts context
- Supported methods are:
  - `Done() <-chan struct{}`
    - Returns a read-only channel that acts as a cancellation signal
    - Catch if the channel is closed to start cancellation
  - `Err() error`
    - Returns an error indicating why the context was cancelled
  - `Deadline() (deadline time.Time, ok bool)`
    - Allows functions to determine wheter they should start work at all
    - Must be set for I/O operations
  - `Value(key any) any`
    - Carries request-scoped data
    - Should be safe for simultaneous use by multiple goroutines
- Derived contexts forms a tree
  - When a context is cancelled, all contexts derived from it are cancelled
- `Background()` is the root of any context tree
  - Never cancelled, no deadline, no values
  - Used for the first context of incoming requests
- `WithCancel()` and `WithTimeout()` derives context that can be cancelled sonner than the parent context
- `WithValue()` provides a way to associate request-scoped values with a context

## Return Type as Channel

When defining a parameter type as channel, you can do three things:

- `chan` means read-write possible
- `<-chan` means read-only
- `chan<-` means write-only

For instance, context's method `Done()` is defined as follows.

```go
type Context interface {
  Done() <-chan struct{}
}
```

This means that the channel generated by `Done()` is read-only for the caller and is not able to write something into the channel.

## Context Should Go Away For Go 2

Summarised from [Context should go away for Go 2](https://faiface.github.io/post/context-should-go-away-go2/).

- Go is a general purpose language, and context is usually for server applications
- Context is like a virus, spreaded all the places soon
- Context's value has serious problems
  - not statically typed at all
  - requires documentation of value specification
  - name collision could happen
  - error-prone magic
  - mostly inefiicient linked list to manage derived context tree (fast with small values, but slow with many values)
- Context just solves cancellation, and it is difficult to solve by other means
- Go should solve cancellation problem with language-specific functionalities
